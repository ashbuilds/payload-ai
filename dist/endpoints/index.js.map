{"version":3,"sources":["../../src/endpoints/index.ts"],"sourcesContent":["import type { SerializedEditorState } from 'lexical'\nimport type { BasePayload, PayloadRequest } from 'payload'\n\nimport Handlebars from 'handlebars'\nimport asyncHelpers from 'handlebars-async-helpers'\n\nimport { ActionMenuItems, Endpoints } from '../types.js'\n\nimport { GenerationModels } from '../ai/models/index.js'\nimport { defaultPrompts } from '../ai/prompts.js'\nimport {\n  PLUGIN_API_ENDPOINT_GENERATE,\n  PLUGIN_API_ENDPOINT_GENERATE_UPLOAD,\n  PLUGIN_INSTRUCTIONS_TABLE,\n  PLUGIN_NAME,\n} from '../defaults.js'\nimport { getFieldBySchemaPath } from '../utilities/getFieldBySchemaPath.js'\nimport { lexicalToHTML } from '../utilities/lexicalToHTML.js'\nimport { lexicalSchema } from '../ai/editor/lexical.schema.js'\nimport { generateText } from 'ai'\nimport { openai } from '@ai-sdk/openai'\n\nconst asyncHandlebars = asyncHelpers(Handlebars)\n\nconst replacePlaceholders = (prompt: string, values: object) => {\n  return asyncHandlebars.compile(prompt, { trackIds: true })(values)\n}\n\nconst assignPrompt = async (\n  action: ActionMenuItems,\n  {\n    type,\n    actionParams,\n    context,\n    field,\n    systemPrompt = '',\n    template,\n    layout,\n  }: {\n    actionParams: Record<any, any>\n    context: object\n    field: string\n    systemPrompt: string\n    template: string\n    type: string\n    layout: string\n  },\n) => {\n  const prompt = await replacePlaceholders(template, context)\n\n  const toLexicalHTML = type === 'richText' ? 'toLexicalHTML' : ''\n\n  const assignedPrompts = {\n    prompt,\n    system: systemPrompt,\n    layout,\n  }\n\n  if (action === 'Compose') {\n    return assignedPrompts\n  }\n\n  const { system: getSystemPrompt, layout: getLayout } = defaultPrompts.find(\n    (p) => p.name === action,\n  )\n\n  let updatedLayout = layout\n  if (getLayout) {\n    updatedLayout = getLayout()\n  }\n\n  const system = getSystemPrompt({\n    ...(actionParams || {}),\n    prompt,\n    systemPrompt,\n  })\n\n  return {\n    prompt: await replacePlaceholders(`{{${toLexicalHTML} ${field}}}`, context),\n    system,\n    layout: updatedLayout,\n  }\n}\n\nconst registerEditorHelper = (payload, schemaPath) => {\n  //TODO: add autocomplete ability using handlebars template on PromptEditorField and include custom helpers in dropdown\n\n  let fieldInfo = getFieldInfo(payload.collections, schemaPath)\n  const schemaPathChunks = schemaPath.split('.')\n\n  asyncHandlebars.registerHelper(\n    'toLexicalHTML',\n    async function (content: SerializedEditorState, options) {\n      const collectionSlug = schemaPathChunks[0]\n      const { ids } = options\n      for (const id of ids) {\n        //TODO: Find a better way to get schemaPath of defined field in prompt editor\n        const path = `${collectionSlug}.${id}`\n        fieldInfo = getFieldInfo(payload.collections, path)\n      }\n\n      const html = await lexicalToHTML(content, fieldInfo.editor?.editorConfig)\n      return new asyncHandlebars.SafeString(html)\n    },\n  )\n}\n\nconst getFieldInfo = (collections: BasePayload['collections'], schemaPath: string) => {\n  let fieldInfo = null\n  //TODO: Only run below for enabled collections\n  for (const collectionsKey in collections) {\n    const collection = collections[collectionsKey]\n    fieldInfo = getFieldBySchemaPath(collection.config, schemaPath)\n    if (fieldInfo) {\n      return fieldInfo\n    }\n  }\n}\n\nexport const endpoints: Endpoints = {\n  textarea: {\n    handler: async (req: PayloadRequest) => {\n      const data = await req.json?.()\n\n      const { locale = 'en', options } = data\n      const { action, actionParams, instructionId } = options\n      const contextData = data.doc\n\n      if (!instructionId) {\n        throw new Error(\n          `Instruction ID is required for \"${PLUGIN_NAME}\" to work, please check your configuration`,\n        )\n      }\n\n      let instructions = await req.payload.findByID({\n        id: instructionId,\n        collection: PLUGIN_INSTRUCTIONS_TABLE,\n      })\n\n      const { collections } = req.payload.config\n      const collection = collections.find(\n        (collection) => collection.slug === PLUGIN_INSTRUCTIONS_TABLE,\n      )\n\n      const { editorConfig: { schema: editorSchema = lexicalSchema() } = {} } =\n        collection.custom || {}\n\n      const { prompt: promptTemplate = '' } = instructions\n\n      const schemaPath = instructions['schema-path'] as string\n      const fieldName = schemaPath?.split('.').pop()\n\n      registerEditorHelper(req.payload, schemaPath)\n\n      const { defaultLocale, locales = [] } = req.payload.config.localization || {}\n      const localeData = locales.find((l) => {\n        return l.code === locale\n      })\n\n      const localeInfo = localeData?.label[defaultLocale] || locale\n\n      //TODO: remove this\n      const opt = {\n        locale: localeInfo,\n        modelId: instructions['model-id'],\n      }\n\n      const model = GenerationModels.find((model) => model.id === opt.modelId)\n      const settingsName = model.settings?.name\n      const modelOptions = instructions[settingsName] as {\n        system: string\n        layout: string\n      }\n\n      const prompts = await assignPrompt(action, {\n        type: instructions['field-type'] as string,\n        actionParams,\n        context: contextData,\n        field: fieldName,\n        systemPrompt: modelOptions.system,\n        template: promptTemplate as string,\n        layout: modelOptions.layout,\n      })\n\n      console.log('Running handler with prompts:', prompts)\n      return model\n        .handler?.(prompts.prompt, {\n          ...modelOptions,\n          ...opt,\n          system: prompts.system,\n          editorSchema,\n          layout: prompts.layout,\n        })\n        .catch((error) => {\n          console.error('Error: endpoint - generating text:', error)\n          return new Response(JSON.stringify(error.message), { status: 500 })\n        })\n    },\n    method: 'post',\n    path: PLUGIN_API_ENDPOINT_GENERATE,\n  },\n  upload: {\n    handler: async (req: PayloadRequest) => {\n      const data = await req.json?.()\n\n      const { options } = data\n      const { instructionId, uploadCollectionSlug } = options\n      const contextData = data.doc\n\n      let instructions = { 'model-id': '', prompt: '' }\n\n      if (instructionId) {\n        // @ts-expect-error\n        instructions = await req.payload.findByID({\n          id: instructionId,\n          collection: PLUGIN_INSTRUCTIONS_TABLE,\n        })\n      }\n\n      const { prompt: promptTemplate = '' } = instructions\n      const schemaPath = instructions['schema-path']\n\n      registerEditorHelper(req.payload, schemaPath)\n\n      const text = await replacePlaceholders(promptTemplate, contextData)\n      const modelId = instructions['model-id']\n      console.log('prompt text:', text)\n\n      const model = GenerationModels.find((model) => model.id === modelId)\n      const settingsName = model.settings?.name\n      const modelOptions = instructions[settingsName] || {}\n      console.log('modelOptions', modelOptions)\n\n      const result = await model.handler?.(text, modelOptions)\n\n      const assetData = await req.payload.create({\n        collection: uploadCollectionSlug,\n        data: result.data,\n        file: result.file,\n      })\n\n      console.log('assetData', assetData)\n\n      return new Response(\n        JSON.stringify({\n          result: {\n            id: assetData.id,\n            alt: assetData.alt,\n          },\n        }),\n      )\n    },\n    method: 'post',\n    path: PLUGIN_API_ENDPOINT_GENERATE_UPLOAD,\n  },\n}\n"],"names":["Handlebars","asyncHelpers","GenerationModels","defaultPrompts","PLUGIN_API_ENDPOINT_GENERATE","PLUGIN_API_ENDPOINT_GENERATE_UPLOAD","PLUGIN_INSTRUCTIONS_TABLE","PLUGIN_NAME","getFieldBySchemaPath","lexicalToHTML","lexicalSchema","asyncHandlebars","replacePlaceholders","prompt","values","compile","trackIds","assignPrompt","action","type","actionParams","context","field","systemPrompt","template","layout","toLexicalHTML","assignedPrompts","system","getSystemPrompt","getLayout","find","p","name","updatedLayout","registerEditorHelper","payload","schemaPath","fieldInfo","getFieldInfo","collections","schemaPathChunks","split","registerHelper","content","options","collectionSlug","ids","id","path","html","editor","editorConfig","SafeString","collectionsKey","collection","config","endpoints","textarea","handler","req","data","json","locale","instructionId","contextData","doc","Error","instructions","findByID","slug","schema","editorSchema","custom","promptTemplate","fieldName","pop","defaultLocale","locales","localization","localeData","l","code","localeInfo","label","opt","modelId","model","settingsName","settings","modelOptions","prompts","console","log","catch","error","Response","JSON","stringify","message","status","method","upload","uploadCollectionSlug","text","result","assetData","create","file","alt"],"mappings":"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"}