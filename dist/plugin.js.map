{"version":3,"sources":["../src/plugin.ts"],"sourcesContent":["import type { Config } from 'payload'\n\nimport { deepMerge } from 'payload/shared'\n\nimport type { PluginConfig } from './types.js'\n\nimport { Instructions } from './collections/Instructions.js'\nimport { PLUGIN_INSTRUCTIONS_MAP_GLOBAL } from './defaults.js'\nimport { endpoints } from './endpoints/index.js'\nimport { init } from './init.js'\nimport { InstructionsProvider } from './providers/InstructionsProvider/index.js'\nimport { translations } from './translations/index.js'\nimport { updateFieldsConfig } from './utilities/updateFieldsConfig.js'\n\nconst payloadAiPlugin =\n  (pluginConfig: PluginConfig) =>\n  (incomingConfig: Config): Config => {\n    const collections = [...(incomingConfig.collections ?? []), Instructions]\n    const { collections: collectionSlugs = [] } = pluginConfig\n\n    let collectionsFieldPathMap = {}\n\n    incomingConfig.admin.components.providers = [\n      ...(incomingConfig.admin.components.providers ?? []),\n      InstructionsProvider,\n    ]\n\n    const updatedConfig: Config = {\n      ...incomingConfig,\n      collections: collections.map((collection) => {\n        if (collectionSlugs.indexOf(collection.slug) > -1) {\n          const { schemaPathMap, updatedCollectionConfig } = updateFieldsConfig(collection)\n          collectionsFieldPathMap = {\n            ...collectionsFieldPathMap,\n            ...schemaPathMap,\n          }\n          return updatedCollectionConfig\n        }\n\n        return collection\n      }),\n      endpoints: [...(incomingConfig.endpoints ?? []), endpoints.textarea, endpoints.upload],\n      globals: [\n        ...incomingConfig.globals,\n        {\n          slug: PLUGIN_INSTRUCTIONS_MAP_GLOBAL,\n          access: {\n            read: () => true,\n          },\n          admin: {\n            hidden: true,\n          },\n          fields: [\n            {\n              name: 'map',\n              type: 'json',\n            },\n          ],\n        },\n      ],\n      i18n: {\n        ...incomingConfig.i18n,\n        translations: {\n          ...deepMerge(translations, incomingConfig.i18n?.translations),\n        },\n      },\n    }\n\n    updatedConfig.onInit = async (payload) => {\n      if (incomingConfig.onInit) await incomingConfig.onInit(payload)\n\n      await init(payload, collectionsFieldPathMap).catch((error) => {\n        payload.logger.error(`â€” AI Plugin: Initialization Error: ${error}`)\n      })\n    }\n\n    return updatedConfig\n  }\n\nexport { payloadAiPlugin }\n"],"names":["deepMerge","Instructions","PLUGIN_INSTRUCTIONS_MAP_GLOBAL","endpoints","init","InstructionsProvider","translations","updateFieldsConfig","payloadAiPlugin","pluginConfig","incomingConfig","collections","collectionSlugs","collectionsFieldPathMap","admin","components","providers","updatedConfig","map","collection","indexOf","slug","schemaPathMap","updatedCollectionConfig","textarea","upload","globals","access","read","hidden","fields","name","type","i18n","onInit","payload","catch","error","logger"],"mappings":"AAEA,SAASA,SAAS,QAAQ,iBAAgB;AAI1C,SAASC,YAAY,QAAQ,gCAA+B;AAC5D,SAASC,8BAA8B,QAAQ,gBAAe;AAC9D,SAASC,SAAS,QAAQ,uBAAsB;AAChD,SAASC,IAAI,QAAQ,YAAW;AAChC,SAASC,oBAAoB,QAAQ,4CAA2C;AAChF,SAASC,YAAY,QAAQ,0BAAyB;AACtD,SAASC,kBAAkB,QAAQ,oCAAmC;AAEtE,MAAMC,kBACJ,CAACC,eACD,CAACC;QACC,MAAMC,cAAc;eAAKD,eAAeC,WAAW,IAAI,EAAE;YAAGV;SAAa;QACzE,MAAM,EAAEU,aAAaC,kBAAkB,EAAE,EAAE,GAAGH;QAE9C,IAAII,0BAA0B,CAAC;QAE/BH,eAAeI,KAAK,CAACC,UAAU,CAACC,SAAS,GAAG;eACtCN,eAAeI,KAAK,CAACC,UAAU,CAACC,SAAS,IAAI,EAAE;YACnDX;SACD;QAED,MAAMY,gBAAwB;YAC5B,GAAGP,cAAc;YACjBC,aAAaA,YAAYO,GAAG,CAAC,CAACC;gBAC5B,IAAIP,gBAAgBQ,OAAO,CAACD,WAAWE,IAAI,IAAI,CAAC,GAAG;oBACjD,MAAM,EAAEC,aAAa,EAAEC,uBAAuB,EAAE,GAAGhB,mBAAmBY;oBACtEN,0BAA0B;wBACxB,GAAGA,uBAAuB;wBAC1B,GAAGS,aAAa;oBAClB;oBACA,OAAOC;gBACT;gBAEA,OAAOJ;YACT;YACAhB,WAAW;mBAAKO,eAAeP,SAAS,IAAI,EAAE;gBAAGA,UAAUqB,QAAQ;gBAAErB,UAAUsB,MAAM;aAAC;YACtFC,SAAS;mBACJhB,eAAegB,OAAO;gBACzB;oBACEL,MAAMnB;oBACNyB,QAAQ;wBACNC,MAAM,IAAM;oBACd;oBACAd,OAAO;wBACLe,QAAQ;oBACV;oBACAC,QAAQ;wBACN;4BACEC,MAAM;4BACNC,MAAM;wBACR;qBACD;gBACH;aACD;YACDC,MAAM;gBACJ,GAAGvB,eAAeuB,IAAI;gBACtB3B,cAAc;oBACZ,GAAGN,UAAUM,cAAcI,eAAeuB,IAAI,EAAE3B,aAAa;gBAC/D;YACF;QACF;QAEAW,cAAciB,MAAM,GAAG,OAAOC;YAC5B,IAAIzB,eAAewB,MAAM,EAAE,MAAMxB,eAAewB,MAAM,CAACC;YAEvD,MAAM/B,KAAK+B,SAAStB,yBAAyBuB,KAAK,CAAC,CAACC;gBAClDF,QAAQG,MAAM,CAACD,KAAK,CAAC,CAAC,mCAAmC,EAAEA,MAAM,CAAC;YACpE;QACF;QAEA,OAAOpB;IACT;AAEF,SAAST,eAAe,GAAE"}